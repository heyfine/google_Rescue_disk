# GCP è°·æ­Œäº‘â€œä¸æ­»é¸Ÿâ€æ•‘ç –æ–¹æ¡ˆï¼šæ‰“é€ ç‹¬ç«‹æ•‘æ´ç›˜ (mfslinux)

# ä¸€é”®å®‰è£…è„šæœ¬ï¼š
bash -c "$(curl -sL https://raw.githubusercontent.com/heyfine/google_Rescue_disk/refs/heads/main/rescue.sh)"

## ğŸ“– å‰è¨€ï¼šä¸ºä»€ä¹ˆè¦è¿™ä¹ˆæŠ˜è…¾ï¼Ÿ

å¾ˆå¤šè–… GCPï¼ˆè°·æ­Œäº‘ï¼‰ç¾Šæ¯›çš„æœ‹å‹éƒ½çŸ¥é“ï¼Œå…è´¹å±‚çº§æœ‰ 30GB çš„ç¡¬ç›˜é¢åº¦ã€‚å¸¸è§„åšæ³•æ˜¯ç›´æ¥å¼€ä¸€ä¸ª 30GB çš„å®ä¾‹ï¼Œä½†å¦‚æœä½ å–œæ¬¢æŠ˜è…¾ç³»ç»Ÿï¼ˆæ¯”å¦‚ DD é‡è£…ã€ä¿®æ”¹åˆ†åŒºï¼‰ï¼Œä¸€æ—¦æŠŠç³»ç»ŸææŒ‚ï¼Œæ•°æ®å°±å¾ˆéš¾æ•‘å›æ¥ã€‚

æœ€ä½³å®è·µæ–¹æ¡ˆï¼šå°† 30GB æ‹†åˆ†ä¸º 15GBï¼ˆç³»ç»Ÿç›˜ï¼‰+ 15GBï¼ˆæ•°æ®ç›˜ï¼‰ã€‚æˆ‘ä»¬åœ¨æ•°æ®ç›˜é‡Œåˆ‡å‡ºä¸€ä¸ª 200MB çš„å°åˆ†åŒºï¼Œè£…å…¥è¿è¡Œåœ¨å†…å­˜ä¸­çš„ mfslinux æ•‘æ´ç³»ç»Ÿã€‚

å¥½å¤„ï¼š

- **ç‰©ç†éš”ç¦»**ï¼šå“ªæ€•ä½ æŠŠä¸»ç³»ç»Ÿ `/dev/sda` æ ¼å¼åŒ–äº†ï¼Œæ•‘æ´ç›˜ `/dev/sdb` ä¾ç„¶å¥åœ¨ã€‚
- **æ•‘ç –ç¥å™¨**ï¼šç³»ç»Ÿå¯åŠ¨å¤±è´¥ï¼ŸGrub è¿›æ•‘æ´æ¨¡å¼ï¼Œè¿ä¸Š SSH éšä¾¿ä¿®ã€‚
- **æ— æŸè°ƒæ•´**ï¼šå¯ä»¥åœ¨æ•‘æ´æ¨¡å¼ä¸‹å¯¹ä¸»ç³»ç»Ÿç¡¬ç›˜è¿›è¡Œæ— æŸæ‰©å®¹/ç¼©å®¹ã€‚

---

## ğŸ› ï¸ ç¬¬ä¸€æ­¥ï¼šç£ç›˜åˆ†åŒº (Disk Partitioning)

å‡è®¾ä½ å·²ç»åˆ›å»ºå¥½å®ä¾‹ï¼Œå¹¶æŒ‚è½½äº†ä¸€å—é¢å¤–çš„ 15GB ç£ç›˜ï¼ˆé€šå¸¸è¯†åˆ«ä¸º `/dev/sdb`ï¼‰ã€‚

ç›®æ ‡ç»“æ„ï¼š
- `/dev/sdb1` (200MB): å­˜æ”¾æ•‘æ´ ISO é•œåƒã€‚
- `/dev/sdb2` (å‰©ä½™ç©ºé—´): ä½ çš„æ•°æ®ç›˜ã€‚

SSH è¿æ¥åï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
# 1. å¯åŠ¨åˆ†åŒºå·¥å…·
fdisk /dev/sdb

# --- fdisk äº¤äº’æ“ä½œ ---
# è¾“å…¥ n (æ–°å»º) -> p (ä¸»åˆ†åŒº) -> 1 (ç¼–å·) -> å›è½¦ (é»˜è®¤èµ·å§‹) -> +200M (å¤§å°)
# è¾“å…¥ n (æ–°å»º) -> p (ä¸»åˆ†åŒº) -> 2 (ç¼–å·) -> å›è½¦ -> å›è½¦ (å‰©ä½™å…¨ç”¨)
# è¾“å…¥ w (ä¿å­˜é€€å‡º)
```

æ ¼å¼åŒ–åˆ†åŒºï¼š

```bash
# æ•‘æ´åˆ†åŒºæ¨èç”¨ ext4 (Grub å…¼å®¹æ€§æœ€å¥½)
mkfs.ext4 /dev/sdb1 -L RESCUE

# æ•°æ®åˆ†åŒºå¯ä»¥ç”¨ä½ å–œæ¬¢çš„ï¼Œæ¯”å¦‚ btrfs æˆ– ext4
mkfs.btrfs /dev/sdb2 -L DATA
```

---

## ğŸ“¥ ç¬¬äºŒæ­¥ï¼šéƒ¨ç½²æ•‘æ´é•œåƒ (Deploy Image)

æˆ‘ä»¬å°† mfslinux ä¸‹è½½åˆ°åˆšåˆšåˆ†å¥½çš„ 200MB åˆ†åŒºé‡Œã€‚mfslinux æ˜¯ä¸€ä¸ªåŸºäº OpenWrt çš„è¶…ç²¾ç®€ Linuxï¼ŒåŠ è½½åˆ°å†…å­˜è¿è¡Œï¼Œé»˜è®¤å¼€å¯ SSHã€‚

```bash
# 1. æŒ‚è½½åˆ†åŒº
mkdir -p /mnt/rescue
mount /dev/sdb1 /mnt/rescue

# 2. ä¸‹è½½é•œåƒ (è¿™é‡Œä½¿ç”¨ 0.1.11 ç‰ˆæœ¬)
cd /mnt/rescue
wget https://mfsbsd.vx.sk/files/iso/mfslinux/mfslinux-0.1.11-94b1466.iso

# 3. é‡å‘½åæ–¹ä¾¿åç»­é…ç½®
mv mfslinux-*.iso rescue.iso

# 4. è·å–åˆ†åŒºçš„ UUID (è®°ä¸‹è¾“å‡ºçš„ UUID="xxxx-xxxx" éƒ¨åˆ†)
blkid /dev/sdb1
```

---

## âš™ï¸ ç¬¬ä¸‰æ­¥ï¼šé…ç½® Grub å¯åŠ¨èœå• (Grub Menu)

æˆ‘ä»¬è¦å‘Šè¯‰ä¸»ç³»ç»Ÿï¼ˆDebian/Ubuntuï¼‰çš„ Grubï¼Œéš”å£ç¡¬ç›˜æœ‰ä¸ªæ•‘å…µã€‚è¯·å°†ä¸‹é¢çš„ `ä½ çš„_UUID` æ›¿æ¢ä¸ºä¸Šä¸€æ­¥è·å–çš„çœŸå® UUIDã€‚

```bash
# å†™å…¥è‡ªå®šä¹‰èœå•é…ç½®
cat <<'EOF' >> /etc/grub.d/40_custom

menuentry "ğŸš‘ Rescue Disk (External sdb1)" {
    insmod part_msdos
    insmod part_gpt
    insmod ext2
    insmod btrfs
    insmod iso9660
    
    # âš ï¸ æ›¿æ¢ä¸‹é¢çš„ UUID
    search --no-floppy --fs-uuid --set=root ä½ çš„_UUID
    
    # é•œåƒè·¯å¾„ (ç›¸å¯¹äº sdb1 æ ¹ç›®å½•)
    set isofile="/rescue.iso"
    
    loopback loop ($root)$isofile
    linux (loop)/isolinux/vmlinuz iso-scan/filename=$isofile inst.stage2=hd:LABEL=MFSLINUX memdisk_size=512M
    initrd (loop)/isolinux/initramfs.igz
}
EOF
```

---

## ğŸ”Œ ç¬¬å››æ­¥ï¼šä¿®å¤ä¸²è¡Œæ§åˆ¶å°æ— æ³•æ“ä½œçš„é—®é¢˜ (å…³é”®ï¼)

è¿™æ˜¯å¾ˆå¤šäººå¤±è´¥çš„åœ°æ–¹ï¼GCP çš„ç½‘é¡µç‰ˆ SSHï¼ˆCloud Shell / Serial Consoleï¼‰ä¾èµ–ä¸²å£é€šä¿¡ã€‚å¦‚æœä½ ç”¨çš„æ˜¯ DD è¿‡çš„ç²¾ç®€ç³»ç»Ÿï¼Œæˆ–è€… Grub é…ç½®è¢«äº‘å‚å•†è„šæœ¬è¦†ç›–ï¼Œä¼šå¯¼è‡´åœ¨å¯åŠ¨èœå•æŒ‰é”®ç›˜æ— ååº”ã€‚

æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªæœ€é«˜ä¼˜å…ˆçº§çš„é…ç½®æ–‡ä»¶ï¼Œå¼ºåˆ¶å¼€å¯ä¸²å£è¾“å…¥æ”¯æŒã€‚

```bash
# åˆ›å»º 99 å·é…ç½®æ–‡ä»¶ (ä¼˜å…ˆçº§æœ€é«˜ï¼Œé˜²æ­¢è¢«è¦†ç›–)
cat <<EOF > /etc/default/grub.d/99-force-serial.cfg
# 1. å¼ºåˆ¶åŒæ—¶å¼€å¯æ˜¾ç¤ºå™¨(console)å’Œä¸²å£(serial)è¾“å‡º
GRUB_TERMINAL="console serial"

# 2. å¼ºåˆ¶è®¾ç½®æ³¢ç‰¹ç‡ (GCP æ ‡å‡†)
GRUB_SERIAL_COMMAND="serial --speed=115200 --unit=0 --word=8 --parity=no --stop=1"

# 3. å¼ºåˆ¶æ˜¾ç¤ºèœå•å¹¶ç­‰å¾… 5 ç§’
GRUB_TIMEOUT=5
GRUB_TIMEOUT_STYLE=menu
EOF
```

---

## ğŸš€ ç¬¬äº”æ­¥ï¼šç”Ÿæ•ˆä¸éªŒè¯

```bash
# 1. æ›´æ–° Grub é…ç½®
update-grub

# 2. é‡å¯
reboot
```

### å¦‚ä½•è¿›å…¥æ•‘æ´æ¨¡å¼ï¼š

1. é‡å¯åï¼Œè¿…é€Ÿæ‰“å¼€ GCP çš„ **Cloud Shell** æˆ– **ä¸²è¡Œæ§åˆ¶å° (Serial Console)**ã€‚
2. ä½ ä¼šçœ‹åˆ° Grub å€’è®¡æ—¶èœå•ï¼ˆæœ‰ 5 ç§’æ—¶é—´ï¼‰ã€‚
3. ä½¿ç”¨é”®ç›˜ **â†‘ / â†“ é”®**ï¼ˆå¦‚æœä¸è¡Œå°è¯• **n / p é”®**ï¼‰é€‰æ‹© **ğŸš‘ Rescue Disk (External sdb1)**ã€‚
4. å›è½¦ç¡®è®¤ã€‚

ç¨ç­‰ç‰‡åˆ»ï¼Œä½ å°†è¿›å…¥ä¸€ä¸ªå…¨æ–°çš„ Linux ç¯å¢ƒï¼

- **é»˜è®¤ç”¨æˆ·**ï¼š`root`
- **é»˜è®¤å¯†ç **ï¼š`mfsroot`

åœ¨è¿™ä¸ªç¯å¢ƒé‡Œï¼Œä½ å¯ä»¥éšæ„æ ¼å¼åŒ– `/dev/sda`ï¼Œæˆ–è€…æŠŠæ•°æ®å¤‡ä»½åˆ° `/dev/sdb2`ï¼Œä½ çš„ VPS å†ä¹Ÿä¸æ€•ç©åäº†ï¼
